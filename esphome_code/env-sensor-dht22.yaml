# ESP Home Environmental Sensor Configuration
# Wemos D1 Mini + DHT22 + 18650 Battery
# Deep sleep enabled for extended battery life

substitutions:
  device_name: "temp-s1"
  friendly_name: "ENV-${device_name}"
  device_description: "Battery powered environmental sensor with DHT22"
  
  # Deep sleep configuration 
  # IMPORTANT: Set to "false" for initial setup and programming
  # Set to "true" for battery-powered operation
  # CRITICAL: D0-RST JUMPER MUST BE CONNECTED!
  # You MUST physically connect a jumper wire from D0 (GPIO16) to RST pin on the Wemos D1 Mini
  # Without this connection, deep sleep will NOT work at all
  deep_sleep_enabled: "false"  # Change to "true" to enable deep sleep mode
  # NOTE: Sleep duration now controlled via runtime "Sleep Interval" number input
  
  # Sensor calibration offsets (edit these values directly)
  temperature_offset: "0.0"  # Temperature offset in Fahrenheit
  humidity_offset: "0.0"     # Humidity offset in %
  sleep_interval_minutes: "10.0"  # Sleep interval in minutes
  
  # NOTE: Sensor calibration now handled via substitution variables (no runtime adjustment)

# set platform and board
esp8266:
  board: esp01_1m

esphome:
  name: "${device_name}"
  friendly_name: ${friendly_name}
  comment: ${device_description}
  
  # Boot priority and initial setup
  on_boot:
    priority: -100
    then:
      - logger.log: "Device booted, starting sensor readings..."
      - delay: 2s  # Allow sensors to stabilize
      
      # Wait for Home Assistant API connection to sync entity states
      - logger.log: "Waiting for Home Assistant connection to sync calibration values..."
      - delay: 10s  # Allow HA to connect and sync number input states
      
      # Log the current calibration values after HA sync
      - logger.log: 
          format: "Calibration values - Temp: ${temperature_offset}Â°F, Humidity: ${humidity_offset}%%, Voltage: ${voltage_multiplier}x"
      - logger.log:
          format: "Deep Sleep Enabled: ${deep_sleep_enabled}, Interval: ${sleep_interval_minutes} minutes"
      
      # Update deep sleep duration based on configured interval value
      - lambda: |-
          float minutes = ${sleep_interval_minutes};
          uint32_t milliseconds = (uint32_t)(minutes * 60.0 * 1000.0);
          ESP_LOGI("deep_sleep", "Setting initial sleep duration to %.1f minutes (%u ms)", minutes, milliseconds);
          id(deep_sleep_control).set_sleep_duration(milliseconds);
      
      # Always take sensor readings first
      - logger.log: "About to update DHT22 sensor..."
      - component.update: dht_sensor
      - logger.log: "DHT22 update command issued, waiting for completion..."
      - delay: 5s  # Allow readings to complete and transmit
      
      # Now check deep sleep settings
      - if:
          condition:
            lambda: 'return strcmp("${deep_sleep_enabled}", "true") == 0;'
          then:
            - logger.log: "Deep sleep enabled - entering sleep after readings"
            - delay: 5s  # Final delay before sleep
            - deep_sleep.enter: deep_sleep_control
          else:
            - logger.log: "Deep sleep disabled in config - device will stay awake"

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "${device_name} Fallback"
    password: !secret ap_password

# Captive portal for easy WiFi configuration
captive_portal:

# Enable logging
logger:
  level: INFO  # Changed to INFO to see temperature update logs
  baud_rate: 115200  # Enable serial logging for debugging

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
  
  # Services for remote control
  services:
    - service: start_deep_sleep
      then:
        - logger.log: "Starting deep sleep via service call"
        - homeassistant.service:
            service: notify.notify
            data:
              title: "${friendly_name}"
              message: "Manually entering deep sleep mode"
        - deep_sleep.enter: deep_sleep_control

# Enable MQTT for retained messages during deep sleep
mqtt:
  broker: !secret mqtt_broker
  username: !secret mqtt_username
  password: !secret mqtt_password
  discovery: true  
  topic_prefix: esphome/${device_name}  # Custom topic prefix
  # MQTT will still handle retained messages in the background

# Enable OTA updates
ota:
  platform: esphome
  password: !secret ota_password

# Web server for diagnostics (optional - disable to save power)  
# DISABLED: To save power in battery mode
# web_server:
#   port: 80
#   auth:
#     username: !secret web_username
#     password: !secret web_password

# Deep sleep configuration
# CRITICAL: For deep sleep to work on ESP8266, you MUST physically connect GPIO16 (D0) to RST pin
# This is a hardware jumper wire connection - it is NOT a software-controlled GPIO
# Without this D0-RST jumper, deep sleep will not function
deep_sleep:
  id: deep_sleep_control
  sleep_duration: 1min  # Default duration, will be updated dynamically
  # Note: ESP8266 wakes via GPIO16 connected to RST - no software configuration needed

# DHT22 sensor configuration
sensor:
  # DHT22 Environmental Sensor
  - platform: dht
    id: dht_sensor
    pin: GPIO14  # D5 on Wemos D1 Mini
    model: DHT22
    temperature:
      name: "Temperature"
      id: temperature
      accuracy_decimals: 1
      filters:
        # Runtime calibration via substitution variable (Fahrenheit to Celsius conversion)
        - lambda: |-
            float offset_f = ${temperature_offset};
            float offset_c = offset_f / 1.8;  // Convert Fahrenheit offset to Celsius
            return x + offset_c;
      on_value:
        then:
          - logger.log: "Temperature value changed!"
      on_raw_value:
        then:
          - logger.log: "Temperature sensor read"
    humidity:
      name: "Humidity"
      id: humidity
      accuracy_decimals: 1
      filters:
        # Runtime calibration via substitution variable
        - lambda: 'return x + ${humidity_offset};'
    update_interval: 5s  # Reduced to 5s for testing to get more frequent updates

# Text sensors for diagnostics
text_sensor:
  # Device info
  - platform: version
    name: "${friendly_name} ESPHome Version"
    entity_category: diagnostic
  
  # WiFi info - REDUCED to save memory
  - platform: wifi_info
    ip_address:
      name: "${friendly_name} IP Address"
      entity_category: diagnostic

# Binary sensors
binary_sensor:
  # Device status
  - platform: status
    name: "Status"
    entity_category: diagnostic
